<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
	"-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- mapper는 다른 것과 구분하기 위해 네임 스페이스를 정해줘야 한다.  
	 그리고 mybatis에서 mapper 처리를 한다. 반드시!!
-->
<mapper namespace="subwaySpot">

	<!-- 지하철 전체 마커 출력을 위한 SQL -->
	<select id="setMarker" resultType="ssVO">
	SELECT
    	si_Name AS name,
    	si_Xpoint AS xpoint,
    	si_Ypoint AS ypoint,
    	sl_Line AS line,
   		sl_Icon AS iconpath
	FROM
    	subwayinfo i join subwayline l
	on
    	i.si_Line = l.sl_Line
    WHERE
		si_hotplace LIKE 'N'
	</select>

	<!-- 핫플레이스 마커 출력을 위한 SQL -->
	<select id="setHotMarker" resultType="ssVO">
	SELECT
    	si_Name AS name,
    	si_Xpoint AS xpoint,
    	si_Ypoint AS ypoint,
    	sl_Line AS line
	FROM
    	subwayinfo i join subwayline l
	on
    	i.si_Line = l.sl_Line
	WHERE
		si_hotplace LIKE 'Y'
	</select>
	
	<!-- 핫플레이스 정보 출력을 위한 sQL -->
	<select id="getHotInfo" resultType="hpVO" parameterType="hpVO">	    
   		SELECT 
        	T2.* 
      	FROM
			(SELECT
				@rownum:=@rownum+1 AS rno,
				T1.*
			FROM (SELECT @rownum:= 0) R,
				(SELECT
			      distinct hi_stname AS station,
	   		   hi_Category AS category,
			      hi_Name AS name,
		   	   hi_EName AS ename,
			      hi_Address AS address,
			      hi_Xpoint AS xpoint,
			      hi_Ypoint AS ypoint,
			      hi_info AS info,
			      hi_image AS imagepath
			  FROM
			     subwayinfo i JOIN hotplaceinfo h
			  on
			     i.si_Name = h.hi_stname
			  WHERE
			  	h.hi_category=#{category} 
			  	AND h.hi_stname = 
			     (SELECT distinct si_name FROM subwayinfo 
			     WHERE si_xpoint= #{lat} AND si_ypoint= #{lng}) 
				ORDER BY hi_stname) T1) T2
			WHERE 
         	rno BETWEEN #{start} AND #{end};
         	
	</select>
	
	<!-- 핫플레이스 마커 클릭 후 주변 검색 클릭시 탭노출을 위한 SQL -->
   <select id="getHotMarker" resultType="hpVO" parameterType="hMap">
   SELECT
      distinct h.hi_stname AS station,
      c.hic_iconpath AS category,
      h.hi_Name AS name,
      h.hi_EName AS ename,
      h.hi_Address AS address,
      h.hi_Xpoint AS xpoint,
      h.hi_Ypoint AS ypoint,
      h.hi_info AS info,
      h.hi_image AS imagepath
   FROM
      subwayinfo i JOIN hotplaceinfo h
   on
      i.si_Name = h.hi_stname
   JOIN hotplaceicon c
   on
      h.hi_Category = c.hic_code
   WHERE
      h.hi_stname = 
      (SELECT distinct si_name FROM subwayinfo 
      WHERE si_xpoint= #{lat} AND si_ypoint= #{lng})
   </select>
   
   <!--  핫플레이스 추천 리스트 페이지 정보를 구하기 위한 총 데이터 개수 구하기 질의 -->
	<select id="getTotal" resultType="int" parameterType="hpVO">
		SELECT 
			COUNT(*) 
		FROM(
			SELECT 
				distinct h.hi_stname, 
				h.hi_Name 
			FROM 
				subwayinfo i JOIN hotplaceinfo h
			ON
			    i.si_Name = h.hi_stname
			WHERE
			    h.hi_stname = 
			     (SELECT distinct si_name FROM subwayinfo 
				     WHERE si_xpoint= #{lat} AND si_ypoint= #{lng})
					  and h.hi_category=#{category}) t1;
		
	</select>
	
	<!-- 검색역 코드 구하기 질의 -->
	<select id="getCode" resultType="sVO" parameterType="String">
		SELECT 
			si_ocode as code,
			si_xpoint as xpoint,
			si_ypoint as ypoint 
		FROM 
			subwayinfo 
		WHERE 
				si_name=#{from} 
			AND si_ocode REGEXP '^-?[0-9]+$'
	</select>
	
	<!-- 역 좌표 구하기 질의 -->
	<select id="getCoords" resultType="hpVO" parameterType="String">
		SELECT 
			si_xpoint as xpoint,
			si_ypoint as ypoint 
		FROM 
			subwayinfo 
		WHERE 
				si_name=#{station} 
			AND si_ocode REGEXP '^-?[0-9]+$'
	</select>
	
	<!-- TabWindow에 들어갈 핫플레이스 info -->
   <select id="getTabinfo" resultType="hpVO" parameterType="hMap">
   SELECT
      distinct h.hi_stname AS station,
      c.hic_iconpath AS category,
      h.hi_Name AS name,
      h.hi_EName AS ename,
      h.hi_Address AS address,
      h.hi_info AS info,
      h.hi_image AS imagepath
   FROM
      hotplaceinfo h JOIN hotplaceicon c
   on
      h.hi_Category = c.hic_code
   WHERE
      hi_xpoint= #{lat} AND hi_ypoint= Round(#{lng},6);
   </select>
   
  <!-- 댓글 게시판 질의문 -->
   <insert id="insertReply" parameterType="rVO">      
      INSERT 
      INTO 
         hotreply
      VALUES
         (NULL, #{hotplacecode}, #{body}, #{nick}, #{pw}, Current_TIMESTAMP);         
   </insert>
   
   <select id="displayReply" parameterType="int" resultType="rVO">
      SELECT
         distinct hr_replycode AS code,
         hr_body   AS body,
         hr_nick     AS nick,
         hr_pass     AS pass,
         hr_date    AS date,
         hr_date   AS time
      FROM
         hotreply r JOIN hotplaceinfo i
      ON
         r.hr_placecode = #{hotplacecode}
      ORDER BY 
         date DESC;   
   </select>
	
</mapper>